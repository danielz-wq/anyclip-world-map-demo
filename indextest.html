<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AnyClip World Map Demo üåç</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --bg:#0b0f14; --panel:#121821; --muted:#9fb0c2; --text:#e6edf3; --accent:#49a0ff;
      --chip:#192231; --chipOn:#1f2b3d; --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    html, body {
      margin: 0;
      height: 100%;
      background: radial-gradient(circle at top, #f3f5fb 0, #dde3f0 40%, #cfd5e1 100%);
      color: #111827;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    /* Map card */
    #map {
      height: 82vh;
      width: 78vw;
      margin: 32px auto;
      border-radius: 18px;
      overflow: hidden;
      background: #ffffff;
      box-shadow:
        0 18px 40px rgba(15,23,42,0.23),
        0 0 0 1px rgba(15,23,42,0.08);
    }

    /* Floating filter panel */
    .filters {
      position: fixed;
      top: 16px; left: 16px;
      width: 320px; max-width: calc(100% - 32px);
      background: var(--panel);
      border: 1px solid #243244;
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }
    .filters h2 {
      margin: 0 0 8px; font-size: 16px; letter-spacing:.2px;
    }
    .row { display: grid; gap: 8px; margin: 10px 0; }
    .group { border-top: 1px solid #223246; padding-top: 10px; }
    .label {
      font-size: 12px; color: var(--muted);
      text-transform: uppercase; letter-spacing: .6px;
    }
    .chips { display:flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .chip {
      background: var(--chip); border: 1px solid #263243; color: var(--text);
      padding: 6px 10px; border-radius: 999px;
      font-size: 12px; cursor: pointer; user-select: none;
    }
    .chip.active {
      background: var(--chipOn); border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(73,160,255,.35) inset;
    }
    .controls { display:flex; gap:8px; align-items:center; }
    .search {
      width:100%; background: #0e141c; border: 1px solid #223246; border-radius: 10px;
      color: var(--text); padding: 8px 10px; outline: none; font-size: 13px;
    }
    .btn {
      background: var(--accent); color: #061320; border: none; border-radius: 10px;
      padding: 8px 10px; font-weight: 600; cursor: pointer; font-size: 12px;
    }
    .meta {
      display:flex; justify-content: space-between; align-items:center;
      font-size:12px; color: var(--muted); margin-top: 6px;
    }
    .toggle {
      position:absolute; top: -12px; right: -12px;
      background:#0e141c; border:1px solid #223246; color:var(--text);
      width: 32px; height:32px; border-radius: 999px;
      cursor:pointer; display:grid; place-items:center; box-shadow:var(--shadow);
    }
    .collapsed { height: 46px; overflow: hidden; padding-bottom: 8px; }

    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
      background:#0e141c; color:var(--text); border:1px solid #2a384b;
    }
    a.link { color: var(--accent); text-decoration: none; }

    /* Player panel */
    .player-panel {
      position: fixed;
      right: 16px; bottom: 16px;
      width: 380px; max-width: calc(100% - 32px);
      background: var(--panel);
      border: 1px solid #243244;
      border-radius: 14px;
      box-shadow: var(--shadow);
      z-index: 999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .player-header {
      display:flex; justify-content:space-between; align-items:center;
      padding: 8px 10px 6px;
      border-bottom: 1px solid #223246;
      background:#0f151f;
      cursor: move;
    }
    .player-title {
      font-size: 13px; font-weight:600;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .player-meta {
      font-size: 11px; color: var(--muted);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .player-close {
      background: transparent; border:none; color:var(--muted);
      font-size: 18px; cursor:pointer; padding: 0 4px;
    }
    .player-body {
      padding: 8px;
      background:#05080e;
    }
    .player-placeholder {
      font-size: 12px; color: var(--muted);
      min-height: 200px;
      display:flex; align-items:center; justify-content:center;
      text-align:center; padding: 10px;
      border: 1px dashed #223246; border-radius: 10px;
    }
    .player-frame-wrap {
      display:none;
      position: relative;
      padding-top: 56.25%; /* 16:9 */
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #223246;
    }
    .player-frame-wrap iframe {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      border:0;
    }

    @media (max-width: 768px) {
      .filters { width:auto; right:16px; }
      .player-panel { left:16px; right:16px; width:auto; }
    }

    /* --- Live event marker styles --- */
    .marker-live-past .dot-past {
      width: 18px;
      height: 18px;
      background: #3da5ff; /* blue */
      border-radius: 50%;
      border: 2px solid white;
    }

    .marker-live-current .dot-current {
      width: 18px;
      height: 18px;
      background: #3cff76; /* green */
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 0 rgba(0,255,0,0.4);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0,255,0,0.5); }
      70% { box-shadow: 0 0 0 12px rgba(0,255,0,0); }
      100% { box-shadow: 0 0 0 0 rgba(0,255,0,0); }
    }

    .marker-live-future .dot-future {
      width: 18px;
      height: 18px;
      background: transparent;
      border-radius: 50%;
      border: 3px solid #00aaff;  /* bright cyan outline */
      opacity: 1;
      box-shadow: 0 0 8px rgba(0,170,255,0.6);
    }


    /* --- Bottom Display Banners --- */
    .banner-row {
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 24px;
      margin: 0 auto 24px;
      margin-top: -8px;
    }

    .banner-slot {
      width: 360px;
      max-width: 42vw;
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid #d4d4d8;
      box-shadow: 0 10px 26px rgba(15,23,42,0.15);
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      cursor: default;
    }

    .banner-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .banner-main {
      font-size: 15px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .banner-sub {
      font-size: 13px;
      color: #4b5563;
      line-height: 1.4;
    }

    @media (max-width: 900px) {
      .banner-row {
        flex-direction: column;
        align-items: center;
      }
      .banner-slot {
        width: 90%;
        max-width: 480px;
      }
    }

    .heat-btn {
      background: #0f172a;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #1d4ed8;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
    }
    .heat-btn:hover {
      background: #1d4ed8;
      color: #f9fafb;
    }

    /* --- Ranking panel: dark, under filters --- */
    .ranking-panel {
      position: fixed;
      left: 16px;
      top: 280px; /* adjust if needed */
      width: 320px;
      max-width: calc(100% - 32px);
      background: var(--panel);
      border: 1px solid #243244;
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 10px 12px;
      font-size: 12px;
      color: var(--text);
      z-index: 950;
    }

    .ranking-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text);
    }

    #rankingList {
      margin: 0;
      padding-left: 18px;
    }

    #rankingList li {
      margin: 2px 0;
      color: var(--muted);
    }

    #rankingList span.score {
      font-weight: 600;
      color: var(--accent);
    }

    #rankingList span.meta {
      color: var(--muted);
    }

    @media (max-width: 768px) {
      .ranking-panel {
        left: 16px;
        right: 16px;
        width: auto;
      }
    }

  /* horizontal score bar */
.rank-barline {
  height: 4px;
  border-radius: 4px;
  margin-top: 3px;
  margin-bottom: 4px;
  background: var(--accent);
  opacity: 0.85;
}
.rank-high  { background:#ef4444 !important; }  /* red */
.rank-mid   { background:#facc15 !important; }  /* yellow */
.rank-low   { background:#22c55e !important; }  /* green */

/* === Control Room Header === */
.control-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 56px;
  background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
  border-bottom: 1px solid #334155;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  z-index: 1100;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.control-logo {
  font-size: 18px;
  font-weight: 700;
  color: #f1f5f9;
  display: flex;
  align-items: center;
  gap: 8px;
}

.control-logo span {
  color: #38bdf8;
}

.control-stats {
  display: flex;
  gap: 32px;
}

.stat-box {
  text-align: center;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: #f1f5f9;
}

.stat-value.live {
  color: #4ade80;
  animation: pulse-text 2s infinite;
}

@keyframes pulse-text {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.stat-label {
  font-size: 10px;
  color: #94a3b8;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* === Alerts Panel === */
.alerts-panel {
  position: fixed;
  top: 72px;
  right: 16px;
  width: 280px;
  background: var(--panel);
  border: 1px solid #243244;
  border-radius: 12px;
  box-shadow: var(--shadow);
  z-index: 1000;
  overflow: hidden;
}

.alerts-header {
  background: #0f151f;
  padding: 10px 12px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
  border-bottom: 1px solid #223246;
  display: flex;
  align-items: center;
  gap: 6px;
}

.alerts-list {
  padding: 8px;
  max-height: 180px;
  overflow-y: auto;
}

.alert-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 8px;
  border-radius: 8px;
  font-size: 11px;
  color: var(--text);
  margin-bottom: 6px;
  background: #0e141c;
  border: 1px solid #1e293b;
}

.alert-item:last-child {
  margin-bottom: 0;
}

.alert-icon {
  font-size: 14px;
  flex-shrink: 0;
}

.alert-item.warning { border-left: 3px solid #f59e0b; }
.alert-item.success { border-left: 3px solid #22c55e; }
.alert-item.info { border-left: 3px solid #3b82f6; }
.alert-item.fire { border-left: 3px solid #ef4444; }

/* Adjust body for header */
body {
  padding-top: 56px;
}

/* Adjust map position */
#map {
  margin-top: 16px;
}

/* Adjust filters panel position */
/* Adjust filters panel position */
.filters {
  top: 72px;
}

    /* === Recommendations Panel === */
.recommendations-panel {
  position: fixed;
  right: 16px;
  top: 260px;
  width: 280px;
  background: var(--panel);
  border: 1px solid #243244;
  border-radius: 12px;
  box-shadow: var(--shadow);
  z-index: 1000;
  overflow: hidden;
  display: none;
}

.recommendations-panel.visible {
  display: block;
}

.recommendations-header {
  background: linear-gradient(135deg, #065f46 0%, #047857 100%);
  padding: 10px 12px;
  font-size: 12px;
  font-weight: 600;
  color: #ecfdf5;
  display: flex;
  align-items: center;
  gap: 6px;
}

.recommendations-list {
  padding: 8px;
  max-height: 220px;
  overflow-y: auto;
}

.rec-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px;
  border-radius: 8px;
  font-size: 11px;
  color: var(--text);
  margin-bottom: 6px;
  background: #0e141c;
  border: 1px solid #1e293b;
  cursor: pointer;
  transition: all 0.2s ease;
}

.rec-item:hover {
  background: #1e293b;
  transform: translateX(2px);
}

.rec-item:last-child {
  margin-bottom: 0;
}

.rec-icon {
  font-size: 18px;
  flex-shrink: 0;
}

.rec-content {
  flex: 1;
}

.rec-title {
  font-weight: 600;
  color: #f1f5f9;
  margin-bottom: 3px;
  line-height: 1.3;
}

.rec-desc {
  color: #94a3b8;
  line-height: 1.4;
}

.rec-tag {
  display: inline-block;
  background: #064e3b;
  color: #6ee7b7;
  font-size: 9px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 4px;
  margin-top: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
    
/* === Publisher Dropdown === */
.publisher-dropdown {
  position: relative;
  display: flex;
  align-items: center;
  gap: 8px;
}

.publisher-dropdown label {
  font-size: 12px;
  color: #94a3b8;
}

.publisher-select {
  background: #1e293b;
  border: 1px solid #334155;
  color: #f1f5f9;
  padding: 8px 32px 8px 12px;
  border-radius: 8px;
  font-family: inherit;
  font-size: 13px;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  min-width: 160px;
}

.publisher-select:hover {
  border-color: #475569;
}

.publisher-select:focus {
  outline: none;
  border-color: #38bdf8;
}

/* Dashboard mode indicator */
.dashboard-mode {
  background: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 600;
  font-size: 14px;
  margin-left: 8px;
}

    
  </style>
</head>
<body>
 <!-- Control Room Header -->
  <div class="control-header">
    <div class="control-logo">
      üéõÔ∏è <span>AnyClip</span> <span id="viewModeTitle">Control Room</span>
    </div>
    
    <div class="publisher-dropdown">
      <label for="publisherSelect">Viewing as:</label>
      <select id="publisherSelect" class="publisher-select">
        <option value="">All Publishers</option>
        <option value="BBC">BBC</option>
        <option value="CNN">CNN</option>
        <option value="YNET">YNET</option>
        <option value="REUTERS">Reuters</option>
      </select>
    </div>

    <div class="control-stats">
      <div class="stat-box">
        <div class="stat-value" id="statPlayers">‚Äî</div>
        <div class="stat-label">Active Players</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="statViews">‚Äî</div>
        <div class="stat-label">Views (24h)</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="statEngagement">‚Äî</div>
        <div class="stat-label">Avg Engagement</div>
      </div>
      <div class="stat-box">
        <div class="stat-value live" id="statLive">‚Äî</div>
        <div class="stat-label">Live Now</div>
      </div>
    </div>
  </div>

  <!-- Recommendations Panel (visible in Publisher Dashboard mode) -->
  <div class="recommendations-panel" id="recommendationsPanel">
    <div class="recommendations-header">
      üí° Recommendations
    </div>
    <div class="recommendations-list" id="recommendationsList">
      <!-- Will be populated by JS -->
    </div>
  </div>
  
  <!-- Alerts Panel -->
  <div class="alerts-panel" id="alertsPanel">
    <div class="alerts-header">
      üîî System Alerts
    </div>
    <div class="alerts-list" id="alertsList">
      <!-- Alerts will be injected here -->
    </div>
  </div>

  <div id="map"></div>

  <!-- Bottom Display Banners -->
  <div class="banner-row">
    <div class="banner-slot">
      <div class="banner-label">Sponsored</div>
      <div class="banner-main">AnyClip Contextual Video Ads</div>
      <div class="banner-sub">
        Reach viewers at the exact moment of highest intent.
      </div>
    </div>

    <div class="banner-slot">
      <div class="banner-label">Partners</div>
      <div class="banner-main">Premium Publisher Inventory</div>
      <div class="banner-sub">
        Showcase your video content on brand-safe, high-impact placements.
      </div>
    </div>
  </div>

  <!-- Floating Filters -->
  <div class="filters" id="filters">
    <button class="toggle" id="toggle" title="Collapse/Expand">‚ñæ</button>
    <!-- Product title -->
    <div style="margin-bottom:12px;">
      <div style="
        font-size:22px;
        font-weight:700;
        color:var(--text);
        letter-spacing:0.4px;
      ">
        AnyClip World Video Pulse üåç
      </div>
      <div style="
        font-size:12px;
        color:var(--muted);
        margin-top:4px;
        line-height:1.35;
      ">
        A real-time global view of trending videos and live events.<br/>
        Filter by region, topic, publisher, and AnyClip Live Events.
      </div>
    </div>

    <h2>Filters</h2>

    <div class="row">
      <div class="controls">
        <input id="search" class="search" placeholder="Search title‚Ä¶ (e.g. Tokyo, marathon, BBC)" />
        <button class="btn" id="reset">Reset</button>
      </div>
    </div>

    <div class="row group">
      <div class="label">Publisher</div>
      <div class="chips" id="sources">
        <div class="chip" data-value="BBC">BBC</div>
        <div class="chip" data-value="CNN">CNN</div>
        <div class="chip" data-value="YNET">YNET</div>
        <div class="chip" data-value="REUTERS">Reuters</div>
      </div>
    </div>

    <div class="row group">
      <div class="label">Topic</div>
      <div class="chips" id="topics">
        <div class="chip" data-value="News">News</div>
        <div class="chip" data-value="Sports">Sports</div>
        <div class="chip" data-value="Tech">Tech</div>
        <div class="chip" data-value="Food">Food</div>
        <div class="chip" data-value="Culture">Culture</div>
      </div>
    </div>

    <div class="row group">
      <div class="label">Region</div>
      <div class="chips" id="regions">
        <div class="chip" data-value="Americas">Americas</div>
        <div class="chip" data-value="Europe">Europe</div>
        <div class="chip" data-value="Asia">Asia</div>
        <div class="chip" data-value="Middle East">Middle East</div>
      </div>
    </div>

    <div class="row group">
      <div class="label">AnyClip Live Events</div>
      <div class="chips" id="liveEvents">
        <div class="chip" data-value="past">Past</div>
        <div class="chip" data-value="current">Current</div>
        <div class="chip" data-value="future">Future</div>
      </div>
    </div>

    <div class="meta">
      <div>
        <div id="count">0 results</div>
        <div id="activeFilters">No filters</div>
      </div>
      <button class="heat-btn" id="heatToggle">Heatmap: Off</button>
    </div>
  </div>

  <!-- Ranking panel under filters -->
  <div class="ranking-panel" id="rankingPanel">
    <div class="ranking-title">Top Videos in Current View</div>
    <ol id="rankingList"></ol>
  </div>

  <!-- Player panel -->
  <div class="player-panel" id="playerPanel">
    <div class="player-header">
      <div>
        <div id="playerTitle" class="player-title">Select a point on the map</div>
        <div id="playerMeta" class="player-meta">No video playing</div>
      </div>
      <button id="playerClose" class="player-close" title="Close">√ó</button>
    </div>
    <div class="player-body">
      <div id="playerPlaceholder" class="player-placeholder">
        Click a marker on the map to start playing a video from that region.
      </div>
      <div class="player-frame-wrap" id="playerFrameWrap">
        <iframe
          id="ytFrame"
          src=""
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
          loading="lazy"
        ></iframe>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    let demoVideos = []; // will be filled from videos.json

    // --- Map init ---
    const worldBounds = L.latLngBounds(
      L.latLng(-85, -180),
      L.latLng(85, 180)
    );

    const map = L.map('map', {
      zoomControl: true,
      maxBounds: worldBounds,
      maxBoundsViscosity: 1.0
    }).setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 7,
      noWrap: true,
      bounds: worldBounds,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // --- Custom marker icons for Live Events ---
    const liveIcons = {
      past: L.divIcon({
        className: "marker-live-past",
        iconSize: [22, 22],
        html: `<div class="dot-past"></div>`
      }),
      current: L.divIcon({
        className: "marker-live-current",
        iconSize: [22, 22],
        html: `<div class="dot-current"></div>`
      }),
      future: L.divIcon({
        className: "marker-live-future",
        iconSize: [22, 22],
        html: `<div class="dot-future"></div>`
      })
    };

    // --- State ---
    let markers = [];
    let heatLayer = null;
    let heatOn = false;
    let currentFiltered = [];

    const state = {
      q: '',
      sources: new Set(),
      topics: new Set(),
      regions: new Set(),
      livePhase: null   // 'past' | 'current' | 'future' | null
    };

    // --- Player elements ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const playerPanel = $('#playerPanel');
    const playerTitle = $('#playerTitle');
    const playerMeta  = $('#playerMeta');
    const playerPlaceholder = $('#playerPlaceholder');
    const playerFrameWrap   = $('#playerFrameWrap');
    const ytFrame = $('#ytFrame');
    const playerClose = $('#playerClose');

    // Publisher URL mapping
    function getPublisherUrl(publisher) {
      const urls = {
        'BBC': 'https://www.bbc.com',
        'CNN': 'https://www.cnn.com',
        'YNET': 'https://www.ynet.co.il',
        'Reuters': 'https://www.reuters.com',
        'Calcalist': 'https://www.calcalist.co.il',
        'Haaretz': 'https://www.haaretz.com',
        'Guardian': 'https://www.theguardian.com',
        'NYT': 'https://www.nytimes.com'
      };
      return urls[publisher] || null;
    }
    
    function escapeHtml(s='') {
      return s.replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"
      }[c]));
    }

    function setCurrentVideo(v) {
      if (!v) return;

      const phaseLabel = v.eventPhase
        ? ` ‚Ä¢ ${v.eventPhase.toUpperCase()} event`
        : '';

      playerTitle.textContent = v.title;

      const scoreText = typeof v.engagementScore === 'number'
        ? ` ‚Ä¢ Score: ${v.engagementScore}/100`
        : '';

      const publisherUrl = getPublisherUrl(v.source);
      if (publisherUrl) {
        playerMeta.innerHTML = 
          `<a href="${publisherUrl}" target="_blank" style="color:#49a0ff;text-decoration:none;">${escapeHtml(v.source)}</a> (Publisher) ‚Ä¢ ${escapeHtml(v.topic)} ‚Ä¢ ${escapeHtml(v.region)}${phaseLabel}${scoreText}`;
      } else {
        playerMeta.textContent =
          `${v.source} (Publisher) ‚Ä¢ ${v.topic} ‚Ä¢ ${v.region}${phaseLabel}${scoreText}`;
      }

      // Future event or no videoId ‚Äì show ‚Äúcoming soon‚Äù
      if (v.eventPhase === 'future' || !v.videoId) {
        ytFrame.src = '';
        playerFrameWrap.style.display   = 'none';
        playerPlaceholder.style.display = 'flex';
        playerPlaceholder.textContent   =
          'This is a planned AnyClip Live Event.\nStay tuned for more details.';
        return;
      }

      // Past / current events ‚Äì play YouTube
      const embedUrl = `https://www.youtube.com/embed/${v.videoId}?autoplay=1&rel=0`;
      ytFrame.src = embedUrl;
      playerPlaceholder.style.display = 'none';
      playerFrameWrap.style.display   = 'block';
    }

    playerClose.addEventListener('click', () => {
      ytFrame.src = '';
      playerFrameWrap.style.display = 'none';
      playerPlaceholder.style.display = 'flex';
      playerTitle.textContent = 'Select a point on the map';
      playerMeta.textContent  = 'No video playing';
    });

    // --- Markers render ---
    function renderMarkers(list) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      list.forEach(v => {
        let markerIcon = null;
        if (v.eventPhase === 'past') {
          markerIcon = liveIcons.past;
        } else if (v.eventPhase === 'current') {
          markerIcon = liveIcons.current;
        } else if (v.eventPhase === 'future') {
          markerIcon = liveIcons.future;
        }

        let liveMessage = '';
        if (v.eventPhase === 'current') liveMessage = 'AnyClip Live Event ‚Äì Streaming now';
        if (v.eventPhase === 'past')    liveMessage = 'Replay available';
        if (v.eventPhase === 'future')  liveMessage = 'Upcoming ‚Äì details soon';

        const publisherUrl = getPublisherUrl(v.source);
        const publisherLink = publisherUrl 
          ? `<a href="${publisherUrl}" target="_blank" style="color:#49a0ff;text-decoration:none;font-size:10px;margin-left:4px;">üîó View site</a>`
          : '';

        const popupText = `
          <b>${escapeHtml(v.title)}</b><br/>
          <small>
            Publisher: ${escapeHtml(v.source)}${publisherLink} ‚Ä¢ Topic: ${escapeHtml(v.topic)} ‚Ä¢ ${escapeHtml(v.region)}
          </small><br/>
          <small style="color:#2563eb;">
            Engagement score: ${v.engagementScore ?? '‚Äì'}/100
          </small><br/>
          ${liveMessage ? `<span style="font-size:11px;color:#49ff9b;">${liveMessage}</span><br/>` : ''}
          <span style="font-size:11px;color:#9fb0c2;">Click to watch in the player</span>
        `;

        const marker = markerIcon
          ? L.marker([v.lat, v.lng], { icon: markerIcon })
          : L.marker([v.lat, v.lng]);

        marker.addTo(map).bindPopup(popupText);

        marker.on('click', () => {
          setCurrentVideo(v);
        });

        markers.push(marker);
      });

      $('#count').textContent = `${list.length} result${list.length === 1 ? '' : 's'}`;
    }

    // --- Heatmap ---
    function updateHeatmap(list) {
      if (!heatOn) {
        if (heatLayer) {
          map.removeLayer(heatLayer);
          heatLayer = null;
        }
        return;
      }

      const points = list
        .filter(v => typeof v.engagementScore === 'number')
        .map(v => [v.lat, v.lng, v.engagementScore / 100]);

      if (heatLayer) {
        map.removeLayer(heatLayer);
        heatLayer = null;
      }
      if (!points.length) return;

      heatLayer = L.heatLayer(points, {
      radius: 25,
      blur: 15,
      gradient: {
        0.1: "#00bfff",
        0.3: "#00ff6a",
        0.5: "#ffff00",
        0.7: "#ff7f00",
        1.0: "#ff0000"
      }
    }).addTo(map);

    }

    // --- Ranking panel ---
    // --- Ranking panel ---
function updateRanking(list) {
  const rankingList = document.getElementById('rankingList');
  if (!rankingList) return;

  rankingList.innerHTML = '';

  if (!list.length) {
    const li = document.createElement('li');
    li.textContent = 'No videos for current filters.';
    rankingList.appendChild(li);
    return;
  }

  const top = [...list]
    .filter(v => typeof v.engagementScore === 'number')
    .sort((a, b) => b.engagementScore - a.engagementScore)
    .slice(0, 5);

  top.forEach(v => {
    const li = document.createElement('li');

    // Score ‚Üí bar color class
    const cls =
      v.engagementScore >= 80 ? 'rank-high' :
      v.engagementScore >= 60 ? 'rank-mid'  :
      'rank-low';

    // Build the ranking item with the score bar
    li.innerHTML =
      `<div>
         <span class="score">${v.engagementScore}</span>
         ‚Äì ${escapeHtml(v.title)}
         <span class="meta">(${escapeHtml(v.region)} ‚Ä¢ ${escapeHtml(v.source)})</span>
       </div>

       <div class="rank-barline ${cls}"
            style="width:${v.engagementScore}%;"></div>`;

    li.style.cursor = 'pointer';

    li.addEventListener('click', () => {
      setCurrentVideo(v);

      if (typeof v.lat === 'number' && typeof v.lng === 'number') {
        map.setView([v.lat, v.lng], Math.max(map.getZoom(), 4));
      }
    });

    rankingList.appendChild(li);
  });
}


    // --- Filters ---
   function applyFilters() {
      const q = state.q.trim().toLowerCase();
      const hasSource    = state.sources.size > 0;
      const hasTopic     = state.topics.size > 0;
      const hasRegion    = state.regions.size > 0;
      const hasLivePhase = !!state.livePhase;

      const filtered = demoVideos.filter(v => {
        // Publisher view filter (from dropdown)
        const matchesPublisherView = !selectedPublisher || v.source === selectedPublisher;
        
        const matchesQ       = !q || v.title.toLowerCase().includes(q);
        const matchesSource  = !hasSource   || state.sources.has(v.source);
        const matchesTopic   = !hasTopic    || state.topics.has(v.topic);
        const matchesRegion  = !hasRegion   || state.regions.has(v.region);
        const matchesLive    = !hasLivePhase || v.eventPhase === state.livePhase;

        return matchesPublisherView && matchesQ && matchesSource && matchesTopic && matchesRegion && matchesLive;
      });

      const af = [];
      if (hasSource)    af.push([...state.sources].join(', '));
      if (hasTopic)     af.push([...state.topics].join(', '));
      if (hasRegion)    af.push([...state.regions].join(', '));
      if (hasLivePhase) af.push(`Live: ${state.livePhase}`);

      $('#activeFilters').textContent = af.length ? af.join(' ‚Ä¢ ') : 'No filters';

      currentFiltered = filtered;
      renderMarkers(filtered);
      updateHeatmap(filtered);
      updateRanking(filtered);
    }

    function wireChips(containerId, targetSet) {
      $$('#' + containerId + ' .chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const val = chip.getAttribute('data-value');
          if (chip.classList.contains('active')) {
            chip.classList.remove('active');
            targetSet.delete(val);
          } else {
            chip.classList.add('active');
            targetSet.add(val);
          }
          applyFilters();
        });
      });
    }

    // --- UI wiring ---
    wireChips('sources', state.sources);
    wireChips('topics', state.topics);
    wireChips('regions', state.regions);

    // Live Events chips ‚Äì single selection
    const liveChips = $$('#liveEvents .chip');
    liveChips.forEach(chip => {
      chip.addEventListener('click', () => {
        const val = chip.getAttribute('data-value');

        if (state.livePhase === val) {
          state.livePhase = null;
          chip.classList.remove('active');
        } else {
          state.livePhase = val;
          liveChips.forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
        }

        applyFilters();
      });
    });

    $('#search').addEventListener('input', (e) => {
      state.q = e.target.value || '';
      applyFilters();
    });

    $('#reset').addEventListener('click', () => {
      state.q = '';
      $('#search').value = '';
      state.sources.clear();
      state.topics.clear();
      state.regions.clear();
      state.livePhase = null;
      $$('.chip.active').forEach(c => c.classList.remove('active'));
      applyFilters();
    });

    const panel = $('#filters');
    const toggle = $('#toggle');
    let collapsed = false;
    toggle.addEventListener('click', () => {
      collapsed = !collapsed;
      panel.classList.toggle('collapsed', collapsed);
      toggle.textContent = collapsed ? '‚ñ∏' : '‚ñæ';
    });

    const heatToggle = document.getElementById('heatToggle');
    if (heatToggle) {
      heatToggle.addEventListener('click', () => {
        heatOn = !heatOn;
        heatToggle.textContent = heatOn ? 'Heatmap: On' : 'Heatmap: Off';
        updateHeatmap(currentFiltered);
      });
    }

    // --- Make panels draggable ---
    function makeDraggable(el, handle) {
      let isDown = false;
      let offsetX = 0;
      let offsetY = 0;

      handle.style.cursor = handle.style.cursor || 'move';

      handle.addEventListener('mousedown', (e) => {
        const t = e.target;
        const tag = t.tagName;
        if (
          tag === 'INPUT' ||
          tag === 'TEXTAREA' ||
          tag === 'BUTTON' ||
          tag === 'SELECT' ||
          t.isContentEditable
        ) {
          return;
        }

        e.preventDefault();
        isDown = true;

        const rect = el.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;

        el.style.right = 'auto';
        el.style.bottom = 'auto';

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });

      function onMouseMove(e) {
        if (!isDown) return;
        el.style.left = (e.clientX - offsetX) + 'px';
        el.style.top  = (e.clientY - offsetY) + 'px';
        // If we're dragging the filters panel, keep the ranking panel under it
        if (el === filtersPanel && rankingPanelEl) {
          positionRankingUnderFilters();
        }
      }

      function onMouseUp() {
        isDown = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }
    }

       const filtersPanel = document.getElementById('filters');
    const playerPanelEl = document.getElementById('playerPanel');
    const playerHeaderEl = playerPanelEl.querySelector('.player-header');
    const rankingPanelEl = document.getElementById('rankingPanel');

    // Position ranking panel just under the filters panel
    function positionRankingUnderFilters() {
      if (!filtersPanel || !rankingPanelEl) return;
      const rect = filtersPanel.getBoundingClientRect();
      rankingPanelEl.style.left = rect.left + 'px';
      rankingPanelEl.style.top  = (rect.bottom + 12) + 'px'; // 12px gap under filters
    }

    makeDraggable(filtersPanel, filtersPanel);
    makeDraggable(playerPanelEl, playerHeaderEl);

    // Initial position when page loads
    positionRankingUnderFilters();


    // --- Load videos from external JSON and then render ---
    fetch('videos.json')
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to load videos.json: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        demoVideos = data.map(v => {
          if (typeof v.engagementScore === 'number') return v;
          const digits = String(v.id || '')
            .split('')
            .filter(ch => ch >= '0' && ch <= '9')
            .join('');
          const base = digits ? parseInt(digits, 10) : Math.floor(Math.random() * 1000);
          const score = 40 + (base * 13) % 60; // 40‚Äì99
          return { ...v, engagementScore: score };
        });

       applyFilters();
        updateControlStats();
        generateAlerts();
        generateRecommendations();
      })
      .catch(err => {
        console.error(err);
      });

    // === Control Room Stats ===
   // === Publisher View State ===
    let selectedPublisher = '';

    // === Publisher Dropdown Handler ===
    document.getElementById('publisherSelect').addEventListener('change', function(e) {
      selectedPublisher = e.target.value;
      
      // Update title
      const titleEl = document.getElementById('viewModeTitle');
      if (selectedPublisher) {
        titleEl.innerHTML = `<span class="dashboard-mode">${selectedPublisher} Dashboard</span>`;
      } else {
        titleEl.textContent = 'Control Room';
      }
      
      // Re-apply everything
      applyFilters();
      updateControlStats();
      generateAlerts();
      generateRecommendations();
    });

    // === Control Room Stats ===
    function updateControlStats() {
      // Filter by selected publisher if set
      const dataSet = selectedPublisher 
        ? demoVideos.filter(v => v.source === selectedPublisher)
        : demoVideos;
      
      const total = dataSet.length;
      if (total === 0) {
        document.getElementById('statPlayers').textContent = '0';
        document.getElementById('statViews').textContent = '0';
        document.getElementById('statEngagement').textContent = '0%';
        document.getElementById('statLive').textContent = '0';
        return;
      }
      
      const liveCount = dataSet.filter(v => v.eventPhase === 'current').length;
      const avgEngagement = Math.round(
        dataSet.reduce((sum, v) => sum + (v.engagementScore || 0), 0) / total
      );
      
      // Simulated 24h views (random but consistent)
      const viewsBase = total * 4200;
      const views = (viewsBase + Math.floor(Math.random() * 100000)).toLocaleString();

      document.getElementById('statPlayers').textContent = total.toLocaleString();
      document.getElementById('statViews').textContent = views;
      document.getElementById('statEngagement').textContent = avgEngagement + '%';
      document.getElementById('statLive').textContent = liveCount;
    }

    // === Alerts Generation ===
    // === Alerts Generation ===
    function generateAlerts() {
      const alertsList = document.getElementById('alertsList');
      
      // Filter by selected publisher if set
      const dataSet = selectedPublisher 
        ? demoVideos.filter(v => v.source === selectedPublisher)
        : demoVideos;
      
      // Find interesting data points for alerts
      const hotVideos = dataSet.filter(v => v.engagementScore >= 90);
      const liveNow = dataSet.filter(v => v.eventPhase === 'current');
      const regions = [...new Set(dataSet.map(v => v.region))];
      
      const alerts = [];

      // High engagement alert
      if (hotVideos.length > 0) {
        alerts.push({
          type: 'fire',
          icon: 'üî•',
          text: `${hotVideos.length} videos with 90+ engagement score`
        });
      }

      // Live events alert
      if (liveNow.length > 0) {
        alerts.push({
          type: 'success',
          icon: 'üü¢',
          text: `${liveNow.length} live event${liveNow.length > 1 ? 's' : ''} streaming now`
        });
      }

      // All systems healthy
      alerts.push({
        type: 'success',
        icon: '‚úÖ',
        text: `All ${regions.length} regions reporting normally`
      });

      // Random spike alert
      const randomTopic = ['Sports', 'News', 'Tech'][Math.floor(Math.random() * 3)];
      const spikePercent = 180 + Math.floor(Math.random() * 200);
      alerts.push({
        type: 'warning',
        icon: '‚ö°',
        text: `Unusual spike in ${randomTopic}: +${spikePercent}%`
      });

      // Render alerts
      alertsList.innerHTML = alerts.map(a => `
        <div class="alert-item ${a.type}">
          <span class="alert-icon">${a.icon}</span>
          <span>${a.text}</span>
        </div>
      `).join('');
    }

    // === Recommendations Generation ===
    function generateRecommendations() {
      const panel = document.getElementById('recommendationsPanel');
      const list = document.getElementById('recommendationsList');
      
      // Only show in publisher dashboard mode
      if (!selectedPublisher) {
        panel.classList.remove('visible');
        return;
      }
      
      panel.classList.add('visible');
      
      // Get publisher's videos
      const publisherVideos = demoVideos.filter(v => v.source === selectedPublisher);
      
      if (publisherVideos.length === 0) {
        list.innerHTML = '<div class="rec-item"><span class="rec-desc">No data available</span></div>';
        return;
      }
      
      // Find insights
      const topVideo = [...publisherVideos].sort((a, b) => b.engagementScore - a.engagementScore)[0];
      const avgScore = Math.round(publisherVideos.reduce((s, v) => s + (v.engagementScore || 0), 0) / publisherVideos.length);
      const globalAvg = Math.round(demoVideos.reduce((s, v) => s + (v.engagementScore || 0), 0) / demoVideos.length);
      const diff = avgScore - globalAvg;
      
      // Get topics breakdown
      const topicCounts = {};
      publisherVideos.forEach(v => {
        topicCounts[v.topic] = (topicCounts[v.topic] || 0) + 1;
      });
      const topTopic = Object.entries(topicCounts).sort((a, b) => b[1] - a[1])[0];
      
      // Get regions breakdown
      const regionCounts = {};
      publisherVideos.forEach(v => {
        regionCounts[v.region] = (regionCounts[v.region] || 0) + 1;
      });
      const topRegion = Object.entries(regionCounts).sort((a, b) => b[1] - a[1])[0];
      
      const recommendations = [];
      
      // Top video recommendation
      if (topVideo && topVideo.engagementScore >= 80) {
        recommendations.push({
          icon: 'üöÄ',
          title: 'Promote Top Performer',
          desc: `"${topVideo.title}" has ${topVideo.engagementScore}/100 engagement. Feature it on your homepage.`,
          tag: 'High Impact'
        });
      }
      
      // Benchmark comparison
      if (diff > 0) {
        recommendations.push({
          icon: 'üìà',
          title: 'Above Market Average',
          desc: `Your engagement is ${diff}% higher than the global average. Keep it up!`,
          tag: 'Insight'
        });
      } else if (diff < -5) {
        recommendations.push({
          icon: '‚ö°',
          title: 'Room for Improvement',
          desc: `Your engagement is ${Math.abs(diff)}% below average. Consider refreshing content strategy.`,
          tag: 'Action Needed'
        });
      }
      
      // Topic recommendation
      if (topTopic) {
        recommendations.push({
          icon: 'üéØ',
          title: `Double Down on ${topTopic[0]}`,
          desc: `${topTopic[0]} is your strongest category with ${topTopic[1]} videos. Produce more content here.`,
          tag: 'Content Strategy'
        });
      }
      
      // Region insight
      if (topRegion) {
        recommendations.push({
          icon: 'üåç',
          title: `Strong in ${topRegion[0]}`,
          desc: `Most of your traffic comes from ${topRegion[0]}. Consider localized content.`,
          tag: 'Geo Insight'
        });
      }
      
      // Live events suggestion
      const liveCount = publisherVideos.filter(v => v.eventPhase === 'current').length;
      if (liveCount === 0) {
        recommendations.push({
          icon: 'üî¥',
          title: 'Try Live Events',
          desc: 'You have no live events. Live content typically gets 40% higher engagement.',
          tag: 'Growth Opportunity'
        });
      }
      
      // Render recommendations
      list.innerHTML = recommendations.map(r => `
        <div class="rec-item">
          <span class="rec-icon">${r.icon}</span>
          <div class="rec-content">
            <div class="rec-title">${r.title}</div>
            <div class="rec-desc">${r.desc}</div>
            <span class="rec-tag">${r.tag}</span>
          </div>
        </div>
      `).join('');
    }
    
    // Update stats periodically (simulate real-time)
    setInterval(() => {
      if (demoVideos.length > 0) {
        updateControlStats();
      }
    }, 30000);
  </script>
</body>
</html>
